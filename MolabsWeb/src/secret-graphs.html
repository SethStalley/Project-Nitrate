<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/highcharts-chart/highcharts-chart.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="app-data.html">
<link rel="import" href="shared-styles.html">

<dom-module id="secret-graphs">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

       p {
        text-align: justify;
        font-size: 12px;
      }

      .align-left {
        float: left;
      }

      .align-right {
        float: right;
      }

      .container {
        padding-bottom: 20px;
      }

      .text-center {
        text-align: center;
      }
    </style>

    <!--Persistent user storage-->
    <iron-localstorage 
        name="user-storage" 
        value="{{storedUser}}"
        on-iron-localstorage-load="_storedUserLoad"></iron-localstorage>
    <app-data key="userData" data="{{storedUser}}"></app-data>

    <iron-ajax
      id="getGraphsAjax"
      content-type="application/json"
      url="http://54.144.112.150/api/selectUserGraphs"
      method="post"
      handle-as="json"
      on-response="handleGraphsResponse">
    </iron-ajax>

    <template is="dom-if" if="[[!storedUser]]">
        <p class="alert-error"><strong>Error:</strong> Please login.</p>
    </template>

    <div class="card" hidden$="![[concentrationVsTimeDate]]">
        <highcharts-chart 
            type="spline" 
            data="{{concentrationVsTimeData}}"
            title='Concentration vs Time' 
            x-zoom 
            x-label="Time" 
            vs-time
            y-label="Concentration">
        </highcharts-chart>

        <div class="container">
            <p class="align-left">Station: <strong>[[storedUser.station]]</strong></p>
            <p class="align-right">As of <strong>[[concentrationVsTimeDate]]</strong></p>
        </div>
    </div>

    <div class="card" hidden$="![[calibrationDate]]">
        <highcharts-chart 
            type="spline" 
            data="{{calibrationData}}"
            title='Calibration' 
            x-zoom 
            x-label="Concentration (mg/L)" 
            y-label="Absorbance (U.A.)">
        </highcharts-chart>

        <div>
          <h4 class="text-center">Wavelength: [[calibrationValues.wavelength]]</h4>
          <h5>Pearson: [[calibrationValues.pearson]]</h5>
          <h5>Intercept: [[calibrationValues.intercept]]</h5>
          <h5>Slope: [[calibrationValues.slope]]</h5>
        </div>

        <div class="container">
            <p class="align-left">Station: <strong>[[storedUser.station]]</strong></p>
            <p class="align-right">As of <strong>[[calibrationDate]]</strong></p>
        </div>
    </div>
      
  </template>

  <script>
    Polymer({
      is: 'secret-graphs',

      properties: {
        concentrationVsTimeData: Object,
        concentrationVsTimeDate: Object,

        calibrationData: Object, 
        calibrationValues: Object,
        calibrationDate:Object
      },

      ready : function() {
         this.setGraphsRequestBody();

         console.log(this.calibrationDate);
      },

      _storedUserLoad: function() {
          this.setGraphsRequestBody();
      },

      setGraphsRequestBody: function() {
        if(this.storedUser) { 
          var body = {
            "pUserNameGraph" : this.storedUser.station, // must change to storedUser.station
            "graphType" : "null", // must change to null
            "pUserName" : this.storedUser.name,
            "pPassword" : this.storedUser.password
          }
          this.$.getGraphsAjax.body = body;
          this.$.getGraphsAjax.generateRequest();
        }
      },

      handleGraphsResponse : function(event) {
        if (event.detail) {
          if(event.detail.response) {
            var calibrationGraph = event.detail.response[0][0].json;
            var concentrationVsTime = event.detail.response[0][2].json;

            //store data for calibration card
            this.calibrationData = this.getGraphData(calibrationGraph);
            this.calibrationDate = this.getDate(event.detail.response[0][0].date);
            this.calibrationValues = JSON.parse(calibrationGraph);

            //store data for concentration vs time card
            this.concentrationVsTimeData = this.getGraphData(concentrationVsTime);
            this.concentrationVsTimeDate = this.getDate(event.detail.response[0][2].date);
          }

        }
        

        //continiously update
         this.async(function() {
           this.$.getGraphsAjax.generateRequest();
         }, 5000);
      },

      getGraphData: function(responseJson) {
        var data = JSON.parse(responseJson);
        var x = JSON.parse(data.x)
        var y= JSON.parse(data.y)
        var response = []

        for (var i=0; i<x.length; i++) {
          var inner = []
          inner.push(x[i])
          inner.push(y[i])
          response.push(inner)
        }

        return response;
      },

      getDate: function(string) {
        var date = new Date(string).toString()
        return date.substring(0, date.length-15)
      }

    });
  </script>
</dom-module>
