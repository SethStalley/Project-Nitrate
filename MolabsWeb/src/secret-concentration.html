<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="app-data.html">
<link rel="import" href="shared-styles.html">

<dom-module id="secret-concentration">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

      h1 {
        font-size: 52px;
        text-align: center;
        -webkit-text-fill-color:var(--app-secondary-color);
      }

      p {
        text-align: justify;
        font-size: 12px;
      }

      .align-left {
        float: left;
      }

      .align-right {
        float: right;
      }

      .container {
        padding-bottom: 20px;
      }

    </style>


    <!--Persistent user storage-->
    <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
    <app-data key="userData" data="{{storedUser}}"></app-data>

    <iron-ajax
      id="getConcentration"
      content-type="application/json"
      url="http://54.144.112.150/api/selectUserGraphs"
      method="post"
      handle-as="json"
      on-response="handleGraphsResponse">
    </iron-ajax>

    <template is="dom-if" if="[[!storedUser]]">
        <p class="alert-error"><strong>Error:</strong> Please login.</p>
    </template>

    <div class="card">
        <h3>Concentration</h3>
        <h1><strong>[[concentration]]</strong></h1>

        <div class="container">
          <p class="align-left">Station: <strong>[[storedUser.station]]</strong></p>
          <p class="align-right">As of <strong>[[date]]</strong></p>
        </div>
    </div>
      
  </template>

  <script>
    Polymer({
      is: 'secret-concentration',

      properties: {
        storedUser :Object,
        concentration: Object,
        date: Object,
      },

      handleGraphsResponse: function() {
        if (event.detail) {
          if(event.detail.response) {
            var concentrationVsTime = event.detail.response[0][2].json;

            //store data for concentration vs time card
            this.concentration = this.getLastConcentration(concentrationVsTime);
            this.date = this.getDate(concentrationVsTime.date);
          }

        }
        
        //continiously update
         this.async(function() {
           this.$.getConcentration.generateRequest();
         }, 5000);
      },

      getLastConcentration: function(jsonString) {
        var data = JSON.parse(jsonString);
        var x = JSON.parse(data.x)
        return x[x.length-1];
      },

      getDate: function(string) {
        var date = new Date(string).toString()
        return date.substring(0, date.length-15)
      },

    });
  </script>
</dom-module>
